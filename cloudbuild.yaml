steps:
  #- name: "gcr.io/cloud-builders/mvn"
 #   args:
#    - package

  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'echo $$VAULT_T']
    secretEnv: ['VAULT_T','PRIV_T']
  
  - name: 'gcr.io/epam-267215/curljq'
    args: ['curl', '-o', '/workspace/txt', '-v', '-k', '-H', 'X-Vault-Token:', '$$VAULT_T', 'https://vault.bugoga.ga/v1/keys/data/web/privkey']
    secretEnv: ['VAULT_T','PRIV_T']

  - name: 'gcr.io/epam-267215/curljq'
    args: ['curl', '-o', '/workspace/ful', '-v', '-k', '-H', 'X-Vault-Token:', "$$VAULT_T", 'https://vault.bugoga.ga/v1/keys/data/web/privkey']
    secretEnv: ['VAULT_T','FULL_T']
 

  - name: 'gcr.io/epam-267215/curljq'
    args: ['cat', '/workspace/txt' ]

  - name: 'gcr.io/epam-267215/curljq'
    entrypoint: /bin/bash
    args: ['-c', 'jq -r .data.data.value /workspace/txt > /workspace/privkey.pem' ]


#  - name: 'gcr.io/epam-267215/curljq'
#    args: ['jq', '-r', '.data.data.value', '/workspace/txt', '>', '/workspace/privkey.pem' ]

  - name: 'gcr.io/epam-267215/curljq'
    args: ['cat', '/workspace/txt' ]

  - name: 'gcr.io/epam-267215/curljq'
    args: ['cat', '/workspace/privkey.pem' ]



  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/tomas:$TAG_NAME', '-t', 'gcr.io/$PROJECT_ID/tomas:latest', '-f', 'Dockerfile2',  '.' ]  
    
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/nginx:$TAG_NAME', '-t', 'gcr.io/$PROJECT_ID/nginx:latest',  '.' ]
    
  - name: 'gcr.io/cloud-builders/kubectl'
    args: [ 'set', 'image', 'deployment/nginx-deployment', 'nginx=gcr.io/$PROJECT_ID/nginx:$TAG_NAME', '--record' ]
    env:
    - 'CLOUDSDK_COMPUTE_ZONE=europe-north1-c'
    - 'CLOUDSDK_CONTAINER_CLUSTER=k8s-epam'

  - name: 'gcr.io/cloud-builders/kubectl'
    args: [ 'set', 'image', 'deployment/tomcat-deployment', 'tomcat=gcr.io/$PROJECT_ID/tomas:$TAG_NAME', '--record' ]
    env:
    - 'CLOUDSDK_COMPUTE_ZONE=europe-north1-c'
    - 'CLOUDSDK_CONTAINER_CLUSTER=k8s-epam'
 

images:
- 'gcr.io/$PROJECT_ID/tomas'   
- 'gcr.io/$PROJECT_ID/nginx'
secrets:
- kmsKeyName: projects/epam-267215/locations/europe-north1/keyRings/google-keys/cryptoKeys/vault-token
  secretEnv:
    VAULT_T: CiQARyYZPDWUioF9jAX/K72QgHMP9a9fHSa107cfxWPNJov1EmISRAAZHrxOeeQD6a55630k3BUDsP+aBcBIMBOcu2NrLhK9zZkMIznGGfaYAk+KwFD4u2pYjftLlWjBtU5E0+s3WJTyM5TG
    PRIV_T: CiQARyYZPDq0ZOBGK7n957TalEhKVkpwHX6vhCkx3FFXW6ChpZ8SWQAZHrxO/Rc4SNhIcDy845PYicUVkEK8nbASm4qZVugn6j4RIazjs2spQ2Mwf92Rj76gaWFpU04LGPJy3G4Gy+IteSueDbFNd5bOuD77QfTjSXQj5kRdT+9R
    FULL_T: CiQARyYZPJnOCyeJ5Gm6nj6ovqg6oNaLROJini3LFwGOfU/LUOkSXAAZHrxOctpy4JjrtkuU94s+k2yt4PBWtrvZsphyqwc0j4XphAti8nNQvhTJECNaQv35rTY+0SofiuKmyuu0ZEvR478tNCdoHVJ2GmuaCg8KmuBMVOQJb/5EmBvN
