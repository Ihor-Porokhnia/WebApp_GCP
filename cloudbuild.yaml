steps:
  - name: "gcr.io/cloud-builders/mvn"
    args:
    - package

  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['-c', 'echo $$VAULT_T']
    secretEnv: ['VAULT_T']
  
  - name: 'gcr.io/epam-267215/curljq'
    args: ['curl', '-v', '-X', 'GET', '-k', "-H X-Vault-Token: s.bUwKOJXY8NblIAmaT0XeFwaT", 'https://vault.bugoga.ga/v1/keys/data/web/privkey', '| jq -r .data.data.value > /workspace/privkey.pem']

  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/tomas:$TAG_NAME', '-t', 'gcr.io/$PROJECT_ID/tomas:latest', '-f', 'Dockerfile2',  '.' ]  
    
  - name: 'gcr.io/cloud-builders/docker'
    args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/nginx:$TAG_NAME', '-t', 'gcr.io/$PROJECT_ID/nginx:latest',  '.' ]
    
  - name: 'gcr.io/cloud-builders/kubectl'
    args: [ 'set', 'image', 'deployment/nginx-deployment', 'nginx=gcr.io/$PROJECT_ID/nginx:$TAG_NAME', '--record' ]
    env:
    - 'CLOUDSDK_COMPUTE_ZONE=europe-north1-c'
    - 'CLOUDSDK_CONTAINER_CLUSTER=k8s-epam'

  - name: 'gcr.io/cloud-builders/kubectl'
    args: [ 'set', 'image', 'deployment/tomcat-deployment', 'tomcat=gcr.io/$PROJECT_ID/tomas:$TAG_NAME', '--record' ]
    env:
    - 'CLOUDSDK_COMPUTE_ZONE=europe-north1-c'
    - 'CLOUDSDK_CONTAINER_CLUSTER=k8s-epam'
 

images:
- 'gcr.io/$PROJECT_ID/tomas'   
- 'gcr.io/$PROJECT_ID/nginx'
secrets:
- kmsKeyName: projects/epam-267215/locations/europe-north1/keyRings/google-keys/cryptoKeys/vault-token
  secretEnv:
    VAULT_T: CiQARyYZPDWUioF9jAX/K72QgHMP9a9fHSa107cfxWPNJov1EmISRAAZHrxOeeQD6a55630k3BUDsP+aBcBIMBOcu2NrLhK9zZkMIznGGfaYAk+KwFD4u2pYjftLlWjBtU5E0+s3WJTyM5TG
